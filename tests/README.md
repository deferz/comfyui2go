# ComfyUI2Go æµ‹è¯•å¥—ä»¶

æœ¬ç›®å½•åŒ…å« ComfyUI2Go åº“çš„æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ï¼ŒæŒ‰åŠŸèƒ½å’Œç±»å‹è¿›è¡Œäº†ç»„ç»‡ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
tests/
â”œâ”€â”€ helpers/               # æµ‹è¯•è¾…åŠ©å‡½æ•°
â”‚   â””â”€â”€ test_helpers.go   # é€šç”¨æµ‹è¯•å·¥å…·å’Œå®¢æˆ·ç«¯åˆ›å»ºå‡½æ•°
â”œâ”€â”€ unit/                 # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ client_test.go    # å®¢æˆ·ç«¯åˆ›å»ºå’Œé…ç½®æµ‹è¯•
â”‚   â””â”€â”€ websocket_test.go # WebSocketåŠŸèƒ½å•å…ƒæµ‹è¯•
â”œâ”€â”€ integration/          # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ basic_api_test.go # åŸºæœ¬APIé›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ websocket_test.go # WebSocketé›†æˆæµ‹è¯•
â”‚   â””â”€â”€ concurrent_test.go # å¹¶å‘åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ test.json           # æµ‹è¯•å·¥ä½œæµæ–‡ä»¶
â”œâ”€â”€ run_tests.sh         # æµ‹è¯•è¿è¡Œå™¨è„šæœ¬
â””â”€â”€ README.md           # æœ¬æ–‡ä»¶
```

## ğŸ§ª æµ‹è¯•ç±»å‹

### å•å…ƒæµ‹è¯• (Unit Tests)
- **ä½ç½®**: `unit/` ç›®å½•
- **ç›®çš„**: æµ‹è¯•ç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—ï¼Œä¸éœ€è¦å¤–éƒ¨ä¾èµ–
- **ç‰¹ç‚¹**: å¿«é€Ÿæ‰§è¡Œï¼Œä¸éœ€è¦çœŸå®çš„ComfyUIæœåŠ¡å™¨
- **åŒ…å«**:
  - å®¢æˆ·ç«¯åˆ›å»ºå’Œé…ç½®
  - WebSocketå¯ç”¨/ç¦ç”¨é€»è¾‘
  - å›è°ƒå‡½æ•°é…ç½®
  - é”™è¯¯å¤„ç†

### é›†æˆæµ‹è¯• (Integration Tests)  
- **ä½ç½®**: `integration/` ç›®å½•
- **ç›®çš„**: æµ‹è¯•ä¸çœŸå®ComfyUIæœåŠ¡å™¨çš„äº¤äº’
- **ç‰¹ç‚¹**: éœ€è¦çœŸå®çš„æœåŠ¡å™¨ç¯å¢ƒï¼Œæ‰§è¡Œæ—¶é—´è¾ƒé•¿
- **åŒ…å«**:
  - APIè°ƒç”¨æµ‹è¯•
  - WebSocketè¿æ¥æµ‹è¯•
  - å·¥ä½œæµæ‰§è¡Œæµ‹è¯•
  - å¹¶å‘æ“ä½œæµ‹è¯•

### æµ‹è¯•è¾…åŠ© (Test Helpers)
- **ä½ç½®**: `helpers/` ç›®å½•
- **ç›®çš„**: æä¾›é€šç”¨çš„æµ‹è¯•å·¥å…·å’Œå®¢æˆ·ç«¯åˆ›å»ºå‡½æ•°
- **åŒ…å«**:
  - `NewTestClient()` - åˆ›å»ºæ ‡å‡†æµ‹è¯•å®¢æˆ·ç«¯
  - `NewTestClientWithOptions()` - åˆ›å»ºè‡ªå®šä¹‰é…ç½®å®¢æˆ·ç«¯
  - `SkipIntegrationTest()` - è·³è¿‡é›†æˆæµ‹è¯•çš„æ¡ä»¶æ£€æŸ¥
  - `CleanupClient()` - æ¸…ç†å®¢æˆ·ç«¯èµ„æº

### æµ‹è¯•æ•°æ® (Test Data)
- **æ–‡ä»¶**: `test.json`
- **ç›®çš„**: é›†æˆæµ‹è¯•ä½¿ç”¨çš„æ ‡å‡†ComfyUIå·¥ä½œæµ
- **ç”¨é€”**: 
  - å·¥ä½œæµæ‰§è¡Œæµ‹è¯•
  - WebSocketè¿æ¥æµ‹è¯•
  - å¹¶å‘ä»»åŠ¡æµ‹è¯•
- **æ ¼å¼**: æ ‡å‡†çš„ComfyUIå·¥ä½œæµJSONæ ¼å¼

## ğŸš€ è¿è¡Œæµ‹è¯•

### ä½¿ç”¨æµ‹è¯•è¿è¡Œå™¨ï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./tests/run_tests.sh all

# åªè¿è¡Œå•å…ƒæµ‹è¯•
./tests/run_tests.sh unit

# åªè¿è¡Œé›†æˆæµ‹è¯•
./tests/run_tests.sh integration

# è¯¦ç»†è¾“å‡ºæ¨¡å¼
TEST_VERBOSE=true ./tests/run_tests.sh all

# è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´
TEST_TIMEOUT=120s ./tests/run_tests.sh integration
```

### ä½¿ç”¨ Go å‘½ä»¤

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
go test -v ./tests/unit/...

# è¿è¡Œé›†æˆæµ‹è¯•
go test -v ./tests/integration/...

# è·³è¿‡é›†æˆæµ‹è¯•ï¼ˆä½¿ç”¨-shortæ ‡å¿—ï¼‰
go test -short -v ./tests/...

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test -v ./tests/...
```

## âš™ï¸ æµ‹è¯•é…ç½®

### ç¯å¢ƒå˜é‡

- `TEST_TIMEOUT`: æµ‹è¯•è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤: 60sï¼‰
- `TEST_VERBOSE`: è¯¦ç»†è¾“å‡ºæ¨¡å¼ï¼ˆé»˜è®¤: falseï¼‰

### é›†æˆæµ‹è¯•è¦æ±‚

é›†æˆæµ‹è¯•éœ€è¦è¿æ¥åˆ°çœŸå®çš„ComfyUIæœåŠ¡å™¨ï¼š

- **æœåŠ¡å™¨åœ°å€**: `http://127.0.0.1:8812/`
- **ç”¨æˆ·å**: `admin`
- **å¯†ç **: `admin123456`

è¿™äº›é…ç½®åœ¨ `helpers/test_helpers.go` ä¸­å®šä¹‰ã€‚

### è·³è¿‡é›†æˆæµ‹è¯•

å¦‚æœæ²¡æœ‰å¯ç”¨çš„ComfyUIæœåŠ¡å™¨ï¼Œå¯ä»¥è·³è¿‡é›†æˆæµ‹è¯•ï¼š

```bash
# ä½¿ç”¨-shortæ ‡å¿—è·³è¿‡é›†æˆæµ‹è¯•
go test -short ./tests/...

# æˆ–è€…ä½¿ç”¨æµ‹è¯•è¿è¡Œå™¨åªè¿è¡Œå•å…ƒæµ‹è¯•
./tests/run_tests.sh unit
```

## ğŸ“ ç¼–å†™æ–°æµ‹è¯•

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```go
package unit

import (
    "testing"
    "github.com/deferz/comfyui2go"
)

func TestNewFeature(t *testing.T) {
    client := comfyui2go.NewClient("test", "http://localhost:8188")
    defer client.CloseWebSocket()
    
    // æµ‹è¯•é€»è¾‘...
}
```

### é›†æˆæµ‹è¯•ç¤ºä¾‹

```go
package integration

import (
    "testing"
    "github.com/deferz/comfyui2go/tests/helpers"
)

func TestNewIntegration(t *testing.T) {
    helpers.SkipIntegrationTest(t)
    
    client := helpers.NewTestClient("test")
    defer helpers.CleanupClient(client)
    
    // æµ‹è¯•é€»è¾‘...
}
```

## ğŸ”§ æœ€ä½³å®è·µ

1. **å•å…ƒæµ‹è¯•**:
   - ä¸“æ³¨äºæµ‹è¯•å•ä¸ªåŠŸèƒ½æ¨¡å—
   - ä¸ä¾èµ–å¤–éƒ¨æœåŠ¡
   - ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å’Œmockå¯¹è±¡
   - å¿«é€Ÿæ‰§è¡Œ

2. **é›†æˆæµ‹è¯•**:
   - æµ‹è¯•å®Œæ•´çš„å·¥ä½œæµç¨‹
   - ä½¿ç”¨çœŸå®çš„æœåŠ¡å™¨è¿æ¥
   - åŒ…å«é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µ
   - æ·»åŠ  `helpers.SkipIntegrationTest(t)` ä»¥æ”¯æŒè·³è¿‡

3. **é€šç”¨è§„åˆ™**:
   - æ€»æ˜¯æ¸…ç†èµ„æºï¼ˆä½¿ç”¨ `defer helpers.CleanupClient(client)`ï¼‰
   - ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
   - æ·»åŠ æ—¥å¿—è¾“å‡ºä»¥ä¾¿è°ƒè¯•
   - æµ‹è¯•æ­£å¸¸æƒ…å†µå’Œé”™è¯¯æƒ…å†µ

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡

æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡ï¼š

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test -coverprofile=coverage.out ./tests/...

# æŸ¥çœ‹è¦†ç›–ç‡
go tool cover -html=coverage.out
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é›†æˆæµ‹è¯•å¤±è´¥**:
   - æ£€æŸ¥ComfyUIæœåŠ¡å™¨æ˜¯å¦å¯è®¿é—®
   - éªŒè¯è®¤è¯ä¿¡æ¯æ˜¯å¦æ­£ç¡®
   - ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸

2. **è¶…æ—¶é”™è¯¯**:
   - å¢åŠ  `TEST_TIMEOUT` ç¯å¢ƒå˜é‡
   - æ£€æŸ¥æœåŠ¡å™¨è´Ÿè½½

3. **WebSocketè¿æ¥å¤±è´¥**:
   - ç¡®è®¤æœåŠ¡å™¨æ”¯æŒWebSocket
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### è°ƒè¯•æŠ€å·§

```bash
# è¯¦ç»†è¾“å‡ºæ¨¡å¼
TEST_VERBOSE=true go test -v ./tests/integration/...

# è¿è¡Œç‰¹å®šæµ‹è¯•
go test -v -run TestSpecificFunction ./tests/unit/...

# ä½¿ç”¨ç«æ€æ£€æµ‹
go test -race ./tests/...
```
